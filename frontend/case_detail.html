<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="js/security.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - Police Intelligence System</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="css/styles.css" rel="stylesheet">
</head>

<body>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column">
            <div class="brand-section">
                <i class="bi bi-shield-shaded"></i>
                <span>N.E.T.R.A.</span>
            </div>

            <div class="nav-list d-flex flex-column">
                <a href="dashboard.html" class="nav-link active">
                    <i class="bi bi-briefcase"></i> Investigations
                </a>
                <a href="requests.html" class="nav-link">
                    <i class="bi bi-telephone-inbound"></i> Telecom Requests
                </a>
                <a href="analytics.html" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> Intel Analytics
                </a>
                <a href="admin.html" class="nav-link">
                    <i class="bi bi-shield-check"></i> Audit Logs
                </a>
            </div>

            <div class="user-profile">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-white d-flex align-items-center justify-content-center text-primary me-2"
                            style="width: 32px; height: 32px; font-size: 0.8rem;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div style="line-height: 1.2;">
                            <div class="small fw-semibold" style="font-size: 0.7rem; opacity: 0.8;"
                                id="userRoleDisplay"></div>
                            <strong id="userNameDisplay" class="text-white" style="font-size: 0.9rem;">Officer</strong>
                        </div>
                    </div>
                    <a href="#" id="logoutBtn" class="text-white opacity-75" title="Secure Logout">
                        <i class="bi bi-box-arrow-right"></i>
                    </a>
                </div>
            </div>

            <div class="sidebar-footer mt-auto">
                <div class="mb-1"><strong>N.E.T.R.A. Portal</strong></div>
                <div>Â© 2026 All Rights Reserved.</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-grow-1 fade-in">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="dashboard.html">Investigation Registry</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Case Dossier</li>
                </ol>
            </nav>

            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title" id="caseTitle"><i class="bi bi-folder2-open me-2"></i>Investigation Record
                    </h1>
                    <div id="caseStatusBadge" class="badge fs-6 mt-2">Loading...</div>
                </div>
                <div>
                    <button class="btn btn-outline-danger btn-sm d-none" id="closeCaseBtn" onclick="closeCase()">
                        <i class="bi bi-x-circle-fill"></i> CONCLUDE INVESTIGATION
                    </button>
                </div>
            </div>

            <div id="alertPlaceholder"></div>

            <div class="row">
                <!-- Case Info -->
                <div class="col-lg-5 mb-4">
                    <div class="card-custom h-100">
                        <div class="card-header">
                            <i class="bi bi-info-circle me-2"></i>Core Case Identification
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4 text-muted">FIR Number</dt>
                                <dd class="col-sm-8 fw-bold text-primary" id="firNumber">-</dd>

                                <dt class="col-sm-4 text-muted">Police Station</dt>
                                <dd class="col-sm-8" id="policeStation">-</dd>

                                <dt class="col-sm-4 text-muted">Classification</dt>
                                <dd class="col-sm-8"><span class="badge bg-light text-dark border"
                                        id="caseType">-</span></dd>

                                <dt class="col-sm-4 text-muted">Date Created</dt>
                                <dd class="col-sm-8" id="createdAt">-</dd>

                                <dt class="col-sm-12 text-muted mt-3">Investigation Summary</dt>
                                <dd class="col-sm-12 bg-light p-3 rounded mt-1" id="caseDesc"
                                    style="min-height: 100px;">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <!-- Financial Intelligence Card (Conditional) -->
                <div class="col-lg-5 mb-4 d-none" id="financialCard">
                    <div class="card-custom h-100 border-warning">
                        <div class="card-header bg-warning-subtle text-dark">
                            <i class="bi bi-bank me-2"></i>Financial Intelligence
                        </div>
                        <div class="card-body">
                            <h6 class="text-muted small fw-bold mb-3">LINKED ENTITIES</h6>
                            <div id="financialEntitiesList" class="mb-4">
                                <!-- Populated by JS -->
                            </div>

                            <hr>

                            <h6 class="text-muted small fw-bold mb-2">ACTIONS</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#npciModal">
                                    <i class="bi bi-shield-lock-fill me-2"></i> Initiate NPCI / Bank Request
                                </button>
                                <button class="btn btn-outline-danger" disabled>
                                    <i class="bi bi-snow2 me-2"></i> Freeze Account (Coming Soon)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evidence / Files -->
                <div class="col-lg-7 mb-4">
                    <div class="card card-custom h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-safe"></i> Secure Evidence Locker</span>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="bi bi-cloud-upload"></i> Upload Evidence
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th class="ps-3">File Name</th>
                                            <th>Type</th>
                                            <th>Integrity (SHA-256)</th>
                                            <th class="text-center">View</th>
                                            <th class="text-end pe-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evidenceTableBody">
                                        <!-- Populated -->
                                    </tbody>
                                </table>
                                <div id="noEvidenceMsg" class="text-center text-muted p-5 d-none">
                                    <i class="bi bi-file-earmark-x fs-1 opacity-25"></i>
                                    <p class="mt-2">No evidence files secured yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-cloud-arrow-up"></i> Secure Evidence Upload</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Evidence Type</label>
                            <select class="form-select" name="file_type" required>
                                <option value="CDR_CSV">CDR (CSV/Excel) - For Analysis</option>
                                <option value="CAF_PDF">CAF (PDF) - Document Analysis</option>
                                <option value="IP_LOG">IP Application Log</option>
                                <option value="OTHER">Other Evidence / Media</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Select File</label>
                            <input type="file" class="form-control" name="file" required>
                        </div>
                        <div class="alert alert-info border-0 shadow-sm">
                            <div class="d-flex">
                                <i class="bi bi-shield-lock-fill fs-4 me-3"></i>
                                <div>
                                    <strong class="d-block">Security Protocol</strong>
                                    <small>Files are automatically hashed (SHA-256) and AES-Encrypted (128-bit) before
                                        storage.</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Encrypt & Store</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-xl modal-dialog-centered transition-all" id="viewModalDialog">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title d-flex align-items-center gap-2">
                        <i class="bi bi-eye-fill"></i>
                        <span>Evidence Analysis</span>
                    </h5>
                    <div class="ms-auto d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-link text-white p-0 me-2" id="resizeModalBtn"
                            title="Toggle Fullscreen">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body bg-light d-flex justify-content-center align-items-center p-0"
                    style="min-height: 500px; max-height: 85vh; overflow: auto; position: relative;" id="viewerBody">
                    <!-- Content Container -->
                    <div id="viewerContent" class="w-100 text-center">
                        <div class="text-white">Loading...</div>
                    </div>
                </div>
                <div class="modal-footer bg-light d-flex justify-content-between">
                    <div>
                        <span class="badge bg-success" id="integrityBadge"><i class="bi bi-shield-check"></i>
                            Integrity Verified</span>
                        <small class="text-muted ms-2" id="evidenceMeta"></small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries for Evidence Viewing -->
    <!-- SheetJS for Excel/CSV -->
    <!-- Libraries for Evidence Viewing (Local for Offline Support) -->
    <!-- SheetJS for Excel/CSV -->
    <script src="js/lib/xlsx.full.min.js"></script>
    <!-- Mammoth for DOCX -->
    <script src="js/lib/mammoth.browser.min.js"></script>
    <!-- JSZip for Archives -->
    <script src="js/lib/jszip.min.js"></script>

    <script src="js/api.js"></script>
    <script src="js/case_detail.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>